function ownKeys(r,e){var t=Object.keys(r);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(r);e&&(o=o.filter(function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})),t.push.apply(t,o)}return t}function _objectSpread(r){for(var e=1;e<arguments.length;e++){var t=null!=arguments[e]?arguments[e]:{};e%2?ownKeys(Object(t),!0).forEach(function(e){_defineProperty(r,e,t[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(t)):ownKeys(Object(t)).forEach(function(e){Object.defineProperty(r,e,Object.getOwnPropertyDescriptor(t,e))})}return r}function _defineProperty(e,r,t){return r in e?Object.defineProperty(e,r,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[r]=t,e}define(["dpz.config","marketconfig/dpz.lang.loyalty","dpz.template","marketconfig/dpz.lang.general","simplr"],function(e,f,r,m,s){function n(n,a){return new Promise(function(e){var r=site.catalogTools.defaultVariantToOrderVariant(n),t=site.catalogTools.orderVariantToURLParameterString(r),o="#!/order/variant/new".concat(t,"&upsellCoupon=").concat(a);s.controller.mRouteAndExecute(o),$(document).one("/order/validate/complete",function(){jsDPZ.app.order.getOrder().data.Details.Coupons.some(function(e){return e.Code===a})?(jsDPZ.app.customer.getCustomer().getSessionData().breadBurnPromoCode=a,site.sessionTools.save().then(function(){e(n),s.controller.mRouteAndExecute("/checkout/payment/")})):(site.func.overlayToggle(!0,"codeOverlay",{},{code:"eLoyaltyDown"}),e(null))})})}function g(r){var t=jsDPZ.app.customer.getCustomer().getSessionData().breadBurnOffers.breadburns.promotionCode,o=jsDPZ.app.customer.getCustomer().data.Email;return jsDPZ.app.customer.getCustomer().getSessionData().breadBurnPromoCode?n(r,jsDPZ.app.customer.getCustomer().getSessionData().breadBurnPromoCode):new Promise(function(e,r){jsDPZ.ajax.claimTargetedOffer({data:{offerId:t,customerEmail:o,pulseOrderGuid:""}}).then(e,r)}).then(function(){var e=(0<arguments.length&&void 0!==arguments[0]?arguments[0]:{}).promoCode;return e?n(r,e):null}).catch(function(){return site.func.overlayToggle(!0,"codeOverlay",{},{code:"eLoyaltyDown"}),null})}function b(){return jsDPZ.app.customer.getCustomer().getSessionData().breadBurnState}function P(){return jsDPZ.app.customer.getCustomer().getSessionData().breadBurnPromoCode}function D(r){C(null);var t=jsDPZ.app.customer.getCustomer().getSessionData().breadBurnPromoCode,e=jsDPZ.app.order.getOrder().data.Details.Coupons.filter(function(e){return e.Code===t}),o=jsDPZ.app.order.getOrder().data.Details.Variants.filter(function(e){return e.Code===r}),n=new Promise(function(e){return $(document).one("/order/coupon/delete/",e)}),a=new Promise(function(e){return $(document).one("/order/variant/delete/",e)});Promise.all([n,a]).then(function(){return s.controller.mRouteAndExecute("/checkout/payment/")}),s.controller.mRouteAndExecute(site.func.buildURL({url:"#!/order/coupons/".concat(e[0].ID,"/delete")})),s.controller.mRouteAndExecute(site.func.buildURL({url:"#!/order/variant/".concat(o[0].ID,"/delete"),parameters:{skipValidation:!0}}))}var o=e.getMarketProperty,y=r.getTranslateContextValue,v=r.contextFixed.market_assets_ctx,C=function(e){jsDPZ.app.customer.getCustomer().getSessionData().breadBurnState=e,site.sessionTools.save()};return{breadBurnEligibleCall:function(){return $.Deferred(function(e){var r=e.resolve,t=e.reject;jsDPZ.app.customer.getCustomer().getSessionData().breadBurnOffers=null,C(null),!function(){var e,r=o("loyalty");return dpz.loyalty.isEnrolled()&&killConfig.isMarketEnabled("loyalty.bread-burns")&&(null===(e=r.breadBurn)||void 0===e?void 0:e.isEnabled)}()?r():jsDPZ.ajax.getTargetedOffer({offerId:"breadburns",email:jsDPZ.app.customer.getCustomer().data.Email,orderId:jsDPZ.app.order.getOrder().data.Details.OrderID}).then(function(){var e=(0<arguments.length&&void 0!==arguments[0]?arguments[0]:{}).offers;jsDPZ.app.customer.getCustomer().getSessionData().breadBurnOffers=e,site.sessionTools.save(),r()}).catch(t)})},renderBreadBurns:function(){var e,r,t=jsDPZ.app.customer.getCustomer().getSessionData().breadBurnOffers,o=(t=void 0===t?{}:t).breadburns,n=(o=void 0===o?[]:o).variantCodes,a=n.indexOf("B8PCGT");-1<a&&(n.splice(a,1),n.unshift("B8PCGT"));var s="B8PCSSF",u=n.indexOf(s);-1<u&&(n.splice(u,1),n.push(s));var d,i,c,l=n.reduce(function(e,r){return e[jsDPZ.app.catalog.getCatalog().data.Variants[r].Name]=r,e},{}),p="bread twists";switch(null===(e=jsDPZ.app.customer.getCustomer().getSessionData().breadBurnOffers)||void 0===e?void 0:null===(r=e.breadburns)||void 0===r?void 0:r.promotionCode){case"scb":d="stuffed cheesy bread",c=!(i="40");break;case"breadtwists":d=p,i="30",c=!0;default:d=p,i="30",c=!0}require(["payment.components"],function(e){var r=e.TranslateContext,t=e.BreadBurn,o={breadProducts:l,loyaltyPoints:jsDPZ.app.customer.getCustomer().data.Loyalty.VestedPointBalance,addBreadBurnCoupon:g,saveBreadBurnProduct:C,loadBreadBurnProduct:b,removeBreadBurnCoupon:D,loadBreadBurnPromoCode:P,market_assets_ctx:v,utag:dpz.utag,eLoyaltyDownPopup:site.func.overlayToggle,breadType:d,pointsCost:i,showLegalText:c};preact.render(preact.h(r.Provider,{value:y(_objectSpread(_objectSpread({},m),f))},preact.h(t,o)),document.querySelector(".js-bread-burn"))})}}});