var _excluded=["transactionId","transactionParameterKey"];function _slicedToArray(e,t){return _arrayWithHoles(e)||_iterableToArrayLimit(e,t)||_unsupportedIterableToArray(e,t)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _iterableToArrayLimit(e,t){var r=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=r){var n,o,a=[],i=!0,s=!1;try{for(r=r.call(e);!(i=(n=r.next()).done)&&(a.push(n.value),!t||a.length!==t);i=!0);}catch(e){s=!0,o=e}finally{try{i||null==r.return||r.return()}finally{if(s)throw o}}return a}}function _arrayWithHoles(e){if(Array.isArray(e))return e}function ownKeys(t,e){var r=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),r.push.apply(r,n)}return r}function _objectSpread(t){for(var e=1;e<arguments.length;e++){var r=null!=arguments[e]?arguments[e]:{};e%2?ownKeys(Object(r),!0).forEach(function(e){_defineProperty(t,e,r[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(r)):ownKeys(Object(r)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(r,e))})}return t}function _defineProperty(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _objectWithoutProperties(e,t){if(null==e)return{};var r,n,o=_objectWithoutPropertiesLoose(e,t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(n=0;n<a.length;n++)r=a[n],0<=t.indexOf(r)||Object.prototype.propertyIsEnumerable.call(e,r)&&(o[r]=e[r])}return o}function _objectWithoutPropertiesLoose(e,t){if(null==e)return{};var r,n,o={},a=Object.keys(e);for(n=0;n<a.length;n++)r=a[n],0<=t.indexOf(r)||(o[r]=e[r]);return o}function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_unsupportedIterableToArray(e)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(e,t){if(e){if("string"==typeof e)return _arrayLikeToArray(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?_arrayLikeToArray(e,t):void 0}}function _iterableToArray(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}function _arrayWithoutHoles(e){if(Array.isArray(e))return _arrayLikeToArray(e)}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}define(["dpz.config","dpz.customer","paymentmodules/dpz.globalPayments.constants"],function(e,t,r){function n(e){jsDPZ.topic(s.NEW_INTENT).publish(e)}function o(e){jsDPZ.topic(s.DELETE_INTENT).publish(e)}var y=e.getMarketProperty,i=t.isProfiled,a=r.amountStatuses,s=r.topics,b=r.redirectLandingPages,f=r.transactionStatuses,c=r.challengeId,u=r.challengeType,l=y("payment"),d=l.nonSupportedPayments,p=void 0===d?[]:d,m=l.splitPayments.enabled;return{addPaymentIntent:n,bindAvailableContactless:function(e,t,r){var n=jsDPZ.app.store.getStore(),o=jsDPZ.app.order.getOrder(),a=n.data,i=a.ContactlessCarryout,s=a.ContactlessDelivery,c=o.data.Details.ServiceMethod;t&&"AVAILABLE"===("Delivery"===c?s:i)&&e.length&&(document.removeEventListener("toggledContactless",r),document.addEventListener("toggledContactless",r))},bindSplitPaymentEvents:function(e){var t=e.module;if(m){jsDPZ.topic(s.UPDATE_PROVIDERS).unsubscribe(t.updateProviders).subscribe(t.updateProviders),jsDPZ.topic(s.START_TRANSACTION).unsubscribe(t.startTransaction).subscribe(t.startTransaction),t.continueTransaction&&jsDPZ.topic(s.CONTINUE_TRANSACTION).unsubscribe(t.continueTransaction).subscribe(t.continueTransaction),jsDPZ.topic(s.RENDER_CHECKOUT).subscribe(function e(){jsDPZ.topic(s.RENDER_CHECKOUT).unsubscribe(e),jsDPZ.topic(s.UPDATE_PROVIDERS).unsubscribe(t.updateProviders),jsDPZ.topic(s.START_TRANSACTION).unsubscribe(t.startTransaction),t.continueTransaction&&jsDPZ.topic(s.CONTINUE_TRANSACTION).unsubscribe(t.continueTransaction)})}},buildRedirectUrl:function(e){var t=e.appLinkScheme,r=e.paymentProviderId,n=e.cartId,o=e.gpmPaymentType,a=e.gpmPaymentSubType,i=e.landingPage,s=void 0===i?b.PAYMENT:i,c=e.isHybrid,u=void 0!==c&&c,l=urlConfig.root,d=y("market-identification").urls[0],p=t?"&scheme=".concat(encodeURIComponent(t)):"",f=u?"&hybrid=true":"";return"https://".concat(window.location.hostname).concat("localhost"===envConfig?":8443":"").concat(l,"/pages/order/").concat(s,"?cartid=").concat(encodeURIComponent(n),"&paymentProviderId=").concat(encodeURIComponent(r),"&redirect=payment&marketUrl=").concat(encodeURIComponent(d),"&gpmPaymentType=").concat(encodeURIComponent(o),"&gpmPaymentSubType=").concat(encodeURIComponent(a||o)).concat(p).concat(f)},createTransaction:function(e){var t=e.sessionId,r=e.transactions,n=e.transaction;jsDPZ.ajax.createPaymentSessionTransaction({sessionId:t,data:{transactions:r}}).then(jsDPZ.topic(s.UPDATE_TRANSACTION).publish,function(){return jsDPZ.topic(s.UPDATE_TRANSACTION).publish(_objectSpread(_objectSpread({},n),{},{status:n.ERROR}))})},errorOverlay:function(e,t,r){var n,o=2<arguments.length&&void 0!==r&&r,a=e,i=[y("payment").callCenterPhone||site.format.phoneNumber({number:jsDPZ.app.store.getStore().data.Phone},"storePhone")];null!=t&&null!==(n=t.response)&&void 0!==n&&n.responseMessage&&!o?(a="eServerMessage",i="Error Reason: ".concat(jsDPZ.util.htmlEscape(t.response.responseMessage)).concat(t.id?" <br>Transaction Reference: ".concat(t.id):"")):null!=t&&t.id&&"eCreditCardRefundTriggered"!==a&&(i=[t.id.toString()].concat(_toConsumableArray(i))),site.func.overlayToggle(!0,"codeOverlay",{},{code:a,label:i},function(){site.func.setupLayerCloseEvents({closeSelector:".js-closeButton",layerSelector:".js-cardOverlay",callback:function(){m||(window.location="".concat(urlConfig.localRoot,"/pages/order/payment"))}})}),"eCreditCardRefundTriggered"===a&&jsDPZ.topic("order.payment.refund").publish()},fetchCards:function(e){var t=e.canUseCards,r=void 0===t||t,n=e.isProfiled,o=e.provider;return n&&r?new Promise(function(t,e){jsDPZ.app.customer.getCustomer().fetchCreditCard().then(function(e){t(o?e.filter(function(e){return Array.isArray(o)?o.includes(e.provider):e.provider===o}):e)}).catch(function(){return e([])})}):Promise.resolve([])},getGPMTransactionNumber:function(e){var t=e.payment,r=t.gpmTransactionNumber,n=t.Type,o=e.order.gpmTransactionNumber;return m&&p.includes(n.toLowerCase())?r:o},getHasIntentsOrTransactions:function(e){var t=e.providers;return(void 0===t?[]:t).some(function(){var e=(0<arguments.length&&void 0!==arguments[0]?arguments[0]:{}).amounts,t=_slicedToArray(e=void 0===e?[]:e,1)[0].status;return[a.SELECTED,a.IN_PROGRESS].includes(t)})},isContactlessEnabled:function(){var e=jsDPZ.app.order.getOrder().data.Details.ServiceMethod;return killConfig.isMarketEnabled("contactless-".concat(e.toLowerCase(),"-orders"))},isSplitPaymentsEnabled:function(){return m},onProviderSelectionUpdate:function(e){var t=e.intent;e.selected?n(t):o(t)},getChallengeResponses:function(){var e=i(),t=y("customerVerification").otpVerification.enabled,r=e&&killConfig.isMarketEnabled("d45149bb-c7ff-4349-95ac-2f5c13efdb12")&&t,n=!e&&killConfig.isMarketEnabled("e31589e3-4302-4467-9700-537c970111fc")&&t,o=r||n,a=jsDPZ.app.customer.getCustomer().data.Session.verificationCode;return o&&a?{challengeResponses:[{type:u.OTP,id:c.OTP,code:a}]}:{}},persistOrder:function(){return jsDPZ.ajax.sessionSave({id:"",data:$.extend({},jsDPZ.app.order.getOrder().data,{Fulfiller:{Groups:[]}}),async:!0}).fail(site.func.powerCommunicationError)},redirectLandingPages:b,removePaymentIntent:o,setGPMTransactionId:function(e){var t=e.gpmTransactionId;jsDPZ.util.sessionStorage("gpmTransactionNumber",t)},showIframe:function(e,c,u){var l=e.transactionId,t=e.transactionParameterKey,d=void 0===t?"codTrans":t,r=_objectWithoutProperties(e,_excluded),p=!1;site.func.overlayToggle(!0,"iFrameOverlay",{keepCentered:!1,xPos:1,yPos:1},_objectSpread({},r),function(){$(window).on("message",function e(t){var r=t.originalEvent;if(r.origin===window.location.origin&&"string"==typeof r.data){var n=JSON.parse(r.data||{})||{},o=n.params,a=void 0===o?"":o;if("signal.iFrameCloseEvent"===n.message){$(window).off("message",e),p=!0;var i=Object.fromEntries(new URLSearchParams(a))||{},s=null!=l?l:i[d];site.func.overlayToggle(!1),site.func.toggleLoading("golopayment",!0),c.fetch($.extend({},u.checkStatusAjaxSettings,{transactionId:s,pollStatus:f.WAITING_CONFIRMATION})).always(function(e){c.handle(e)})}}}),$(window).trigger("scroll.layer"),setTimeout(function(){p||(site.func.overlayToggle(!1),window.location.reload())},9e5)})}}});