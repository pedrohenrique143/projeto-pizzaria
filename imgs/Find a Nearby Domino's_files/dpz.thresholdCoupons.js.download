function _slicedToArray(o,e){return _arrayWithHoles(o)||_iterableToArrayLimit(o,e)||_unsupportedIterableToArray(o,e)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _iterableToArrayLimit(o,e){var r=null==o?null:"undefined"!=typeof Symbol&&o[Symbol.iterator]||o["@@iterator"];if(null!=r){var t,n,a=[],u=!0,i=!1;try{for(r=r.call(o);!(u=(t=r.next()).done)&&(a.push(t.value),!e||a.length!==e);u=!0);}catch(o){i=!0,n=o}finally{try{u||null==r.return||r.return()}finally{if(i)throw n}}return a}}function _arrayWithHoles(o){if(Array.isArray(o))return o}function ownKeys(e,o){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var t=Object.getOwnPropertySymbols(e);o&&(t=t.filter(function(o){return Object.getOwnPropertyDescriptor(e,o).enumerable})),r.push.apply(r,t)}return r}function _objectSpread(e){for(var o=1;o<arguments.length;o++){var r=null!=arguments[o]?arguments[o]:{};o%2?ownKeys(Object(r),!0).forEach(function(o){_defineProperty(e,o,r[o])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):ownKeys(Object(r)).forEach(function(o){Object.defineProperty(e,o,Object.getOwnPropertyDescriptor(r,o))})}return e}function _defineProperty(o,e,r){return e in o?Object.defineProperty(o,e,{value:r,enumerable:!0,configurable:!0,writable:!0}):o[e]=r,o}function _toConsumableArray(o){return _arrayWithoutHoles(o)||_iterableToArray(o)||_unsupportedIterableToArray(o)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(o,e){if(o){if("string"==typeof o)return _arrayLikeToArray(o,e);var r=Object.prototype.toString.call(o).slice(8,-1);return"Object"===r&&o.constructor&&(r=o.constructor.name),"Map"===r||"Set"===r?Array.from(o):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?_arrayLikeToArray(o,e):void 0}}function _iterableToArray(o){if("undefined"!=typeof Symbol&&null!=o[Symbol.iterator]||null!=o["@@iterator"])return Array.from(o)}function _arrayWithoutHoles(o){if(Array.isArray(o))return _arrayLikeToArray(o)}function _arrayLikeToArray(o,e){(null==e||e>o.length)&&(e=o.length);for(var r=0,t=new Array(e);r<e;r++)t[r]=o[r];return t}define("dpz.thresholdCoupons",["simplr","dpz.config"],function(d,o){function l(o){var e=jsDPZ.app.catalog.getCatalog().getCoupon(o).data,r=(e=void 0===e?{}:e).Tags;return(r=void 0===r?{}:r).NoManualEntryByUser}function s(o){var e=jsDPZ.app.catalog.getCatalog().getCoupon(o).data,r=(e=void 0===e?{}:e).Tags,t=(r=void 0===r?{}:r).DeliveryDiscount,n=r.MinimumPaymentAmount,a=r.ThresholdCoupon;return n&&(a||t)}function i(o){var e;return null===(e=jsDPZ.app.catalog.getCatalog().getCoupon(o).data)||void 0===e?void 0:e.Tags.DeliveryDiscount}function c(o){var e=(0<arguments.length&&void 0!==o?o:jsDPZ.app.order.getOrder()).data.Details,r=e.StoreID,t=void 0===r?"":r,n=e.ServiceMethod,a=e.Variants,u=void 0===a?[]:a,i=e.Coupons,d=(void 0===i?[]:i).filter(function(o){var e=o.Code;return o.Fulfilled&&!s(e)}).map(function(o){return o.Code}).sort(function(o,e){return o.localeCompare(e)}).join("-"),l=_toConsumableArray(u).sort(function(o,e){return o.ID-e.ID}).map(function(o){var e=o.Code,r=void 0===e?"":e,t=o.Qty,n=void 0===t?0:t,a=o.Sides,u=void 0===a?{}:a,i=o.Toppings,d=void 0===i?{}:i;return btoa("".concat(r,"-").concat(n,"-").concat(JSON.stringify(u),"-").concat(JSON.stringify(d)))}).join("-");return"".concat(t,"-").concat(n,"-").concat(d,"-").concat(l)}function p(o){var e=0<arguments.length&&void 0!==o?o:jsDPZ.app.order.getOrder(),r=c(e);return P[r]||{}}function f(o){var e=0<arguments.length&&void 0!==o?o:{},r=e.extend,t=void 0===r||r,n=e.key,a=void 0===n?"":n,u=e.value,i=void 0===u?{}:u;P[a]=_objectSpread(_objectSpread({},t&&P[a]),i)}function v(o){var r=o.amounts,e=t("order").thresholdCouponsCustomerAmountFields;return(void 0===e?[]:e).reduce(function(o,e){return o+function(o){var e=o.amounts,r=void 0===e?{}:e,t=o.field;return void 0!==r[t]?+r[t]:0}({amounts:r,field:e})},0)}function n(o,e){var r=o.data.Tags,t=r.MinimumPaymentAmount,n=r.ThresholdPriority,a=e.data.Tags,u=a.MinimumPaymentAmount,i=a.ThresholdPriority;return n||i?n?i?parseInt(n)-parseInt(i):-1:1:parseInt(u)-parseInt(t)}function y(o,e){var r=o.data.Tags.MinimumPaymentAmount,t=e.data.Tags.MinimumPaymentAmount;return r===t?n(o,e):parseInt(r)-parseInt(t)}function m(o){return jsDPZ.app.catalog.isCouponActive(o).Success}function g(o){var e=o.coupon,r=o.amounts,t=v({amounts:r}),n=e.data,a=n.Code,u=n.Tags.MinimumPaymentAmount,i=m(a),d=parseFloat(t)>=parseFloat(u);return i&&d}function a(o){var e=0<arguments.length&&void 0!==o?o:jsDPZ.app.order.getOrder(),r=p(e),a=c(e),t=r.amounts,n=e.data.Details.Coupons.every(function(o){var e=o.Code;return!s(e)});if(!jsDPZ.util.empty(t))return Promise.resolve(t);if(!n||jsDPZ.util.empty(e.data.Details.Amounts))return new Promise(function(t,n){return site.func.getOrderForPowerData().then(function(o){return o.Order.Coupons=o.Order.Coupons.filter(function(o){var e=o.Code;return!s(e)}),jsDPZ.ajax.priceOrder({data:o})}).then(function(o){if(0<=o.Status){var e=new jsDPZ.obj.order;e.updateDataFromPowerResponse(o);var r=e.data.Details.Amounts;f({key:a,value:{amounts:r}}),t(r)}else n(new Error("Price order failed"))})});var u=Object.entries(e.data.Details.Amounts).reduce(function(o,e){var r=_slicedToArray(e,2),t=r[0],n=r[1];return _objectSpread(_objectSpread({},o),{},_defineProperty({},t,parseFloat(n)))},{});return f({key:a,value:{amounts:u}}),Promise.resolve(u)}function r(o){var e=(0<arguments.length&&void 0!==o?o:{}).onlyAutomaticallyApplied,t=void 0!==e&&e;return jsDPZ.app.catalog.getCatalog().getCouponsArray().filter(function(o){var e=o.data,r=(e=void 0===e?{}:e).Code;return s(r)&&m(r)&&(!t||l(r))}).sort(n)}function C(o){var e=(0<arguments.length&&void 0!==o?o:{}).onlyAutomaticallyApplied;return r({onlyAutomaticallyApplied:void 0===e||e}).sort(n).reduce(function(o,e){return o[i(e.data.Code)?"deliveryDiscountCoupons":"thresholdCoupons"].push(e),o},{deliveryDiscountCoupons:[],thresholdCoupons:[]})}function e(o){var e=(0<arguments.length&&void 0!==o?o:{order:r}).order,r=void 0===e?jsDPZ.app.order.getOrder():e,t=p(r).eligibleThresholdCoupons;return void 0!==t?Promise.resolve(t):a(r).then(function(e){function o(o){return g({coupon:o,amounts:e})}var r=C({onlyAutomaticallyApplied:!0}),t=r.deliveryDiscountCoupons,n=void 0===t?[]:t,a=r.thresholdCoupons,u=void 0===a?[]:a,i={deliveryDiscountCoupon:n.find(o),thresholdCoupon:u.find(o)};return f({key:c(),value:{eligibleThresholdCoupons:i}}),i})}function h(r){return new Promise(function(n){var a=(site.catalogTools.defaultVariantToOrderVariant(site.catalogTools.getDefaultVariantCode(r.data.Code))||{}).Code,o={code:a,qty:1,skipValidation:!0,suppressWizard:!0},u="/order/variant/new/";$(document).on(u,function o(e,r){var t=r.variantCode;a===t&&($(document).off(u,o),n())});var e=site.func.buildURL({url:"#!/order/variant/new",parameters:o});d.controller.mRouteAndExecute(e)})}function b(o){var n=o.couponCode,e=o.suppressWizard,a="/order/coupon/add/",u="order.coupon.rejected",r=_objectSpread({code:n,couponAdd:1,qty:1,suppressValidation:!0},e&&{suppressWizard:"1"}),t=site.func.buildURL({url:"#!/order/coupons/new",parameters:r}),i=new Promise(function(r){function t(o,e){((null==o?void 0:o.couponCode)||(null==e?void 0:e.couponCode))===n&&(jsDPZ.topic(u).unsubscribe(t),$(document).off(a,t),r())}jsDPZ.topic(u).subscribe(t),$(document).on(a,t)});return d.controller.mRouteAndExecute(t),Promise.all([].concat(_toConsumableArray(function(n){return Object.keys(jsDPZ.app.catalog.getCatalog().data.Products).map(function(o){return jsDPZ.app.catalog.getCatalog().getProduct(o)}).filter(function(o){var e=o.data,r=(e=void 0===e?{}:e).Tags,t=(r=void 0===r?{}:r).CouponOnly;return(void 0===t?"":t)===n})}(n).map(h)),[i]))}function A(o){var a=o.ID;return new Promise(function(t){var n="/order/coupon/delete/",o=site.func.buildURL({url:"#!/order/coupons/".concat(a,"/delete"),parameters:{skipValidation:!0}});$(document).on(n,function o(e,r){r.orderCouponID===a&&($(document).off(n,o),t())}),d.controller.mRouteAndExecute(o)})}var t=o.getMarketProperty,P={};return{applyThresholdCoupons:function(){var d=jsDPZ.app.order.getOrder().data.Details.Coupons;return e().then(function(o){var e,r,t=o.deliveryDiscountCoupon,n=o.thresholdCoupon,a=[{couponCode:null==t?void 0:null===(e=t.data)||void 0===e?void 0:e.Code,suppressWizard:"1"},{couponCode:null==n?void 0:null===(r=n.data)||void 0===r?void 0:r.Code}].filter(function(o){var e=o.couponCode;return Boolean(e)}),u=a.filter(function(o){var e=o.couponCode;return d.every(function(o){return o.Code!==e})}),i=d.filter(function(o){var e=o.Code;return s(e)&&l(e)&&a.every(function(o){return o.couponCode!==e})});return Promise.all([].concat(_toConsumableArray(i.map(A)),_toConsumableArray(u.map(b)))).then(function(){return Boolean(i.length||u.length)})})},filterDeliveryDiscountProduct:function(o){var e,r,t=o.Code,n=jsDPZ.app.catalog.getCatalog(),a=(Object.values(n.data.Coupons).find(function(o){var e=o.Code;return i(e)})||{}).Code,u=n.getVariant(t).data.ProductCode;return(null===(e=n.getProduct(u).data)||void 0===e?void 0:null===(r=e.Tags)||void 0===r?void 0:r.CouponOnly)!==a},getAreThresholdCouponsAvailable:function(){return r({onlyAutomaticallyApplied:!0}).length},getIsAutomaticallyApplied:l,getIsDeliveryDiscountCoupon:i,getIsDeliveryDiscountCouponInOrder:function(o){return o.orderData.Details.Coupons.some(function(o){var e=o.Code;return i(e)})},getIsThresholdCoupon:s,getNextNonEligibleThresholdCoupons:function(o){var e=(0<arguments.length&&void 0!==o?o:{}).order,r=void 0===e?jsDPZ.app.order.getOrder():e,t=p(r).nextNonEligibleThresholdCoupons;return void 0!==t?Promise.resolve(t):a(r).then(function(e){function o(o){return!g({coupon:o,amounts:e})}var r=C({onlyAutomaticallyApplied:!0}),t=r.deliveryDiscountCoupons,n=void 0===t?[]:t,a=r.thresholdCoupons,u=void 0===a?[]:a,i={deliveryDiscountCoupon:n.sort(y).find(o),thresholdCoupon:u.sort(y).find(o)};return f({key:c(),value:{nextNonEligibleThresholdCoupons:i}}),i})},getThresholdCoupons:r,getThresholdOrderAmount:function(o){var e=(0<arguments.length&&void 0!==o?o:{}).order,r=void 0===e?jsDPZ.app.order.getOrder():e;return a(r).then(function(o){return v({amounts:o})})}}});