var _excluded=["valid","providers"];function _slicedToArray(e,t){return _arrayWithHoles(e)||_iterableToArrayLimit(e,t)||_unsupportedIterableToArray(e,t)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _iterableToArrayLimit(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=n){var r,o,a=[],i=!0,s=!1;try{for(n=n.call(e);!(i=(r=n.next()).done)&&(a.push(r.value),!t||a.length!==t);i=!0);}catch(e){s=!0,o=e}finally{try{i||null==n.return||n.return()}finally{if(s)throw o}}return a}}function _arrayWithHoles(e){if(Array.isArray(e))return e}function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_unsupportedIterableToArray(e)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(e,t){if(e){if("string"==typeof e)return _arrayLikeToArray(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?_arrayLikeToArray(e,t):void 0}}function _iterableToArray(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}function _arrayWithoutHoles(e){if(Array.isArray(e))return _arrayLikeToArray(e)}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function _objectWithoutProperties(e,t){if(null==e)return{};var n,r,o=_objectWithoutPropertiesLoose(e,t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(r=0;r<a.length;r++)n=a[r],0<=t.indexOf(n)||Object.prototype.propertyIsEnumerable.call(e,n)&&(o[n]=e[n])}return o}function _objectWithoutPropertiesLoose(e,t){if(null==e)return{};var n,r,o={},a=Object.keys(e);for(r=0;r<a.length;r++)n=a[r],0<=t.indexOf(n)||(o[n]=e[n]);return o}function ownKeys(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),n.push.apply(n,r)}return n}function _objectSpread(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?ownKeys(Object(n),!0).forEach(function(e){_defineProperty(t,e,n[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):ownKeys(Object(n)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))})}return t}function _defineProperty(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}define("paymentmodules/dpz.globalPayments.transactionManager",["simplr","dpz.config","dpz.template","site.funcs","paymentmodules/dpz.globalPayments.constants","paymentmodules/dpz.globalPayments.funcs"],function(d,e,t,n,r,o){function a(e){return le=e,jsDPZ.util.sessionStorage(z,e.id),le}function l(){le=null,pe=[],fe=[],me={},jsDPZ.util.sessionStorage(z,""),jsDPZ.util.sessionStorage(B,"[]")}function i(){return new Promise(function(t,n){function r(e){a(e),t(le)}function o(e){return jsDPZ.topic(k.LOG_ERROR).publish({tags:["".concat(T,".create-session")],error:e})}site.func.getOrderForPowerData().then(function(e){jsDPZ.ajax.createPaymentSession({data:{order:{orderRequest:e}},placeOrder:_objectSpread({},oe)}).then(r).fail(function(e){o(e),400<e.status?jsDPZ.ajax.createPaymentSession({data:{order:{id:jsDPZ.app.order.getOrder().data.Details.OrderID}},placeOrder:_objectSpread({},oe)}).then(r).fail(function(e){o(e),n(e)}):n(e)})})})}function s(e){return new Promise(function(t,n){return jsDPZ.ajax.getPaymentSession({sessionId:e}).then(function(e){a(e),t(le)}).fail(function(e){404===(null==e?void 0:e.status)?(l(),i().then(t).catch(n)):(jsDPZ.topic(k.LOG_ERROR).publish({tags:"".concat(T,".get-session"),error:e}),n(e))})})}function p(e){var t,n=0<arguments.length&&void 0!==e?e:null===(t=le)||void 0===t?void 0:t.id;return new Promise(function(t){jsDPZ.ajax.cancelPaymentSession({sessionId:n}).then(function(){l(),t()}).fail(function(e){jsDPZ.topic(k.LOG_ERROR).publish({tags:"".concat(T,".cancel-session"),error:e}),l(),t()})})}function f(){var e;return(null===(e=le)||void 0===e?void 0:e.id)||jsDPZ.util.sessionStorage(z)}function u(e){var t=e.transactions,o=void 0===t?[]:t;return new Promise(function(e,t){var n=(le||{}).id,r=void 0===n?"":n;jsDPZ.ajax.getPaymentSessionProviders({sessionId:r,data:{transactions:o.map(function(e){return e})}}).then(e).fail(function(e){jsDPZ.topic(k.LOG_ERROR).publish({tags:["".concat(T,".get-session")],error:e}),t(e)})})}function c(e){var t=e.complete,n=void 0!==t&&t,r=e.providers,o=void 0===r?[]:r,a=e.remainingBalance,i=e.valid,s=void 0!==i&&i;if(ye=s&&n,s){function u(e){var t=e.status;return j.SELECTED===t}pe=o.filter(function(e){var t=e.amounts;return(void 0===t?[]:t).some(u)}).map(function(e){var t=e.id;return e.amounts.filter(u).map(function(e){return{providerId:t,amount:e}})}).flat(),jsDPZ.topic(k.UPDATE_PROVIDERS).publish({complete:n,lastKnownRemainders:me,providers:o,transactions:fe});var c=(pe.find(function(e){return e.amount.type===A.REMAINDER})||{}).amount,d=(c=void 0===c?{}:c).amount,l=ue&&d?d:a,p=E("numbers");$(".js-remainingBalanceAmount").text(g(l,p));var f=document.querySelector(be);ve&&ye&&f&&(ve=!1,preact.render(null,f))}}function m(e){function n(e,n){var t=e.amounts;return(void 0===t?[]:t).some(function(e){var t=e.type;return e.status===j.AVAILABLE&&t===n})}var t=e.providers;return e.valid&&t.some(function(e){return n(e,A.REMAINDER)})&&J&&(me=t.reduce(function(e,t){return _objectSpread(_objectSpread({},e),{},_defineProperty({},t.id,t.enabled&&(n(t,A.REMAINDER)||n(t,A.WHOLE_ORDER))))},{})),e}function y(e){var t=e.valid,n=e.providers,r=_objectWithoutProperties(e,_excluded);return t?_objectSpread({valid:t,providers:n},r):u({transactions:[]})}function v(e){var t=e.providerId,n=e.amount;jsDPZ.topic(k.NEW_INTENT).publish({providerId:t,amount:n})}function b(e){var t,n,s=e.onError,u=e.transaction,r=u.providerId,c=u.status,o=(null===(n={WOW:(t={},_defineProperty(t,G.DECLINED,"eWowPaymentAuthorizationFailed"),_defineProperty(t,G.TECHNICAL_ERROR,"eWowPaymentAuthorizationFailed"),t)}[r])||void 0===n?void 0:n[c])||"";$(".js-placeOrder").prop("disabled",!1),fe.some(function(e){var t=e.status;return!h.includes(t)})?require(["payment.components","marketconfig/dpz.lang.forms","marketconfig/dpz.lang.payment"],function(e,t,n){var r=e.SplitPaymentTransactionErrorModal,o=e.TranslateContext,a=c===G.PLACE_ORDER_FAILED?U.PLACE_ORDER_FAILED_WITH_REFUND:U.PAYMENT_SESSION_CANCELLED_WITH_REFUND,i="/payment/checkout/?createNewPaymentSession=true&showRefundMessage=true&refundMessageCode=".concat(a);c===G.PLACE_ORDER_FAILED?(l(),d.controller.mRouteAndExecute(i),jsDPZ.topic("order.payment.refund").publish()):te?p().then(function(){jsDPZ.topic("order.payment.refund").publish(),d.controller.mRouteAndExecute(i)}):(site.func.toggleLoading("golopayment",!1),preact.render(preact.h(o.Provider,{value:O(_objectSpread(_objectSpread({},t),n))},preact.h(r,{site:site,cancelSession:function(){p().then(function(){jsDPZ.topic("order.payment.refund").publish(),d.controller.mRouteAndExecute(i)})},choosePayment:function(){v(u),null==s||s()}})),document.body))}):(site.func.toggleLoading("golopayment",!1),v(u),[G.DECLINED,G.AUTHORIZATION_FAILED].includes(c)?K(o||"ePaymentDeclined",u):c===G.CANCELLED?K(o||"ePaymentCancelled",u):R.includes(c)||N.includes(r)?K(o||"ePaymentTechnicalError",u):M.includes(c)&&(K(o||"eCreditCardRefundTriggered",u),jsDPZ.topic("order.payment.refund").publish()),null==s||s())}function P(e){var i=e.id,o=e.transaction;s(i).then(function(e){var t=e.order.orderRequest.Order,n=e.status;if(n===G.SUCCESS){var r=fe.filter(function(e){var t=e.status;return!h.includes(t)}).map(function(e){var t=e.id,n=e.amount,r=e.gratuity,o=e.providerId,a=e.transactionMerchant;return{Type:C[o]||o,Amount:null==n?void 0:n.amount,TipAmount:null==r?void 0:r.amount,CardType:"",sessionId:i,transactionId:t,gpmTransactionNumber:a||t||i}});l(),require(["dpz.placeorder"],function(e){e.success($.extend(!0,{},{Order:_objectSpread(_objectSpread({},t),{},{Payments:[]})},{Order:{Payments:r},Details:{StoreOrderID:t.StoreOrderID}}))})}else n===G.PLACE_ORDER_STARTED?window.setTimeout(function(){return P({id:i,transaction:o})},ie):n===G.PLACE_ORDER_FAILED&&b(o)})}function _(e){var t=(0<arguments.length&&void 0!==e?e:{}).validate;if(void 0!==t&&t&&!ye)$(".js-placeOrder").prop("disabled",!1),require(["payment.components","marketconfig/dpz.lang.payment"],function(e,t){var n=e.TranslateContext,r=e.ErrorNotification;ve=!0;var o=document.querySelector(be);o&&preact.render(preact.h(n.Provider,{value:O(_objectSpread({},t))},preact.h(r,{translationKey:"payment.select_more_payment_options"})),o)});else{function n(e){var t=e.status;return h.includes(t)}var r=(le||{}).id,o=void 0===r?"":r,a=[].concat(_toConsumableArray(fe.filter(function(e){var t=e.status;return t===!t||L.includes(t)})),_toConsumableArray(pe.sort(function(e,t){var n=e.amount.type,r=t.amount.type;return I[n]-I[r]}))),i=a[0],s=a.slice(1);if(i){function u(e){return!e.id}if(pe=s.filter(u),u(i))jsDPZ.topic(k.START_TRANSACTION).publish(_objectSpread(_objectSpread({},i),{},{sessionId:o}));else{var c=i.status,d=i.waitingForUser;!function(e){var t=e.transactionIntents,n=void 0===t?[]:t;jsDPZ.util.sessionStorage(B,n)}({transactionIntents:pe}),c===G.WAITING_CONFIRMATION||d?jsDPZ.topic(k.CONTINUE_TRANSACTION).publish(_objectSpread(_objectSpread({},i),{},{sessionId:o})):jsDPZ.topic(k.UPDATE_TRANSACTION).publish({transactions:[i]})}}else fe.length&&fe.every(function(e){return e.status===G.SUCCESS})?P({id:f(),transaction:fe[fe.length-1]}):fe.some(n)&&b({transaction:fe.reverse().find(n)})}}var E=e.getMarketProperty,g=t.formatMoney,O=t.getTranslateContextValue,S=n.func.toggleLoading,j=r.amountStatuses,A=r.amountTypes,I=r.amountTypesOrder,T=r.ERROR_TAG,h=r.errorStatuses,D=r.nonRefundableErrorStatuses,R=void 0===D?[]:D,N=r.nonRefundableProviders,C=r.paymentTypeMappers,w=r.pendingStatuses,L=void 0===w?[]:w,Z=r.placingOrderStatuses,W=void 0===Z?[]:Z,x=r.refundableErrorStatuses,M=void 0===x?[]:x,F=r.refundMessageCodes,U=void 0===F?{}:F,z=r.SESSION_STORAGE,k=r.topics,G=r.transactionStatuses,H=r.waitingStatuses,q=void 0===H?[]:H,K=o.errorOverlay,B="dpzPaymentIntents",V=E("payment").splitPayments,Y=V.allowsRemainderReplacement,J=void 0!==Y&&Y,Q=V.enabled,X=void 0!==Q&&Q,ee=V.forceCancellationOnError,te=void 0!==ee&&ee,ne=V.nonSupportedPayments,re=void 0===ne?[]:ne,oe=V.placeOrder,ae=V.sessionPollingWaitMillis,ie=void 0===ae?5e3:ae,se=V.showRemainingBalanceAmount,ue=void 0===se||se,ce=V.transactionPollingWaitMillis,de=void 0===ce?1e3:ce,le=null,pe=[],fe=[],me={},ye=!1,ve=!1,be=".js-paymentFormError";return jsDPZ.topic(k.NEW_INTENT).subscribe(function(e){function r(e){return e===A.REMAINDER}function o(e){return e===A.WHOLE_ORDER}var t,n,a=pe;a=J&&r(null===(t=e.amount)||void 0===t?void 0:t.type)?[].concat(_toConsumableArray(pe.filter(function(e){var t=e.amount,n=(t=void 0===t?{}:t).type;return!r(n)&&!o(n)})),[e]):o(null===(n=e.amount)||void 0===n?void 0:n.type)?[e]:[].concat(_toConsumableArray(pe),[e]),u({transactions:_toConsumableArray(a)}).then(y).then(m).then(c)}),jsDPZ.topic(k.DELETE_INTENT).subscribe(function(e){var t=e.providerId,n=e.amount,r=(n=void 0===n?{}:n).type;pe=pe.filter(function(e){return e.providerId!==t||e.amount.type!==r}),u({transactions:_toConsumableArray(pe)}).then(y).then(m).then(c)}),jsDPZ.topic(k.RESET_INTENTS).subscribe(function(){u({transactions:[]}).then(y).then(m).then(c)}),jsDPZ.topic(k.UPDATE_TRANSACTION).subscribe(function t(e){var n=e.onError,r=_slicedToArray(e.transactions,1)[0];fe=fe.some(function(e){return e.id===r.id})?fe.map(function(e){return e.id===r.id?r:e}):[].concat(_toConsumableArray(fe),[r]),r.status===G.DUPLICATE_ORDER?require(["dpz.placeorder"],function(e){S("golopayment",!1),e.duplicateOrderHandler()}):h.includes(r.status)?b({transaction:r,onError:n}):[G.PENDING,G.WAITING_NOTIFICATION].includes(r.status)&&!r.waitingForUser?window.setTimeout(function(){return jsDPZ.ajax.getPaymentTransaction({transactionId:r.id}).then(function(e){return t({transactions:[e]})})},de):r.status===G.PAYMENT_COMPLETED?_():W.includes(r.status)?P({id:f(),transaction:r}):q.includes(r.status)&&!r.waitingForUser?window.setTimeout(function(){return function(e){var n=e.transactionId;return new Promise(function(e,t){jsDPZ.ajax.getPaymentTransaction({transactionId:n}).then(e).fail(t)})}({transactionId:r.id}).then(function(e){return t({transactions:[e]})})},de):r.status!==G.WAITING_CONFIRMATION&&!r.waitingForUser||jsDPZ.topic(k.CONTINUE_TRANSACTION).publish(_objectSpread({},r))}),jsDPZ.topic(k.UPDATE_PROVIDERS).subscribe(console.log),{cancelSession:p,getArePaymentSupported:function(e){return e.payments.every(function(e){var t=e.gpmPaymentType;return!re.includes(t)})},getSession:function(e){var t=(0<arguments.length&&void 0!==e?e:{}).sessionId,n=void 0===t?"":t;return le?Promise.resolve(le):n?s(n):i()},getSessionId:f,getSessionProviders:u,getTransactions:function(){return new Promise(function(n,t){var e=(le||{}).id,r=void 0===e?"":e;jsDPZ.ajax.getPaymentSessionTransactions({sessionId:r}).then(function(e){var t=e.transactions;n(fe=t)}).fail(function(e){jsDPZ.topic(k.LOG_ERROR).publish({tags:["".concat(T,".get-transactions")],error:e}),t(e)})})},isTransactionManagerEnabled:function(){return X},loadIntents:function(){pe=JSON.parse(jsDPZ.util.sessionStorage(B)||"[]")},resetSession:l,resumeTransactions:_,updateLastKnownRemainder:m,updateOrder:function(e){var n=e.order,t=(le||{}).id,r=void 0===t?"":t;return new Promise(function(t){fe.length?t(le):jsDPZ.ajax.updatePaymentSessionOrder({sessionId:r,data:{Order:n.Order}}).then(function(e){t(le=e)})})}}});